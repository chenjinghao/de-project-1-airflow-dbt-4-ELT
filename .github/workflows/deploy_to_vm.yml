name: Deploy to Google Cloud VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Update VM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to VM
        run: |
          # Create .env file securely on the runner
          cat <<EOF > .env
          AIRFLOW__CORE__TEST_CONNECTION=enabled
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
          MINIO_ROOT_USER=${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD }}
          SLACK_API_TOKEN=${{ secrets.SLACK_API_TOKEN }}
          ALPHA_VANTAGE_API_KEY=${{ secrets.ALPHA_VANTAGE_API_KEY }}
          EOF

          # Create airflow_settings.yaml file securely on the runner
          cat <<EOF > airflow_settings.yaml
          connections:
            - conn_id: minio
              conn_type: aws
              description: "MinIO Object Storage"
              login: ${{ secrets.MINIO_ROOT_USER }}
              password: ${{ secrets.MINIO_ROOT_PASSWORD }}
              extra:
                endpoint_url: "http://minio:9000"

            - conn_id: postgres_stocks
              conn_type: postgres
              description: "Stocks PostgreSQL Database"
              host: database
              login: ${{ secrets.POSTGRES_USER }}
              password: ${{ secrets.POSTGRES_PASSWORD }}
              schema: ${{ secrets.POSTGRES_DB }}
              port: ${{ secrets.POSTGRES_PORT }}

            - conn_id:  stock_api
              conn_type: http
              description: "Alpha Vantage Stock API"
              host: "https://www.alphavantage.co/query"
              password: ${{ secrets.ALPHA_VANTAGE_API_KEY }}

            - conn_id: slack
              conn_type: slack
              password: ${{ secrets.SLACK_API_TOKEN }}

          pools:
            - pool_name: api_pool
              pool_slot: 1
              pool_description: "Alpha Vantage API rate limiting"
          EOF


          SSH_USER="${{ secrets.SSH_USERNAME }}"
          
          # 1. Update Code on VM (same as before)
          gcloud compute ssh $SSH_USER@${{ secrets.INSTANCE_NAME }} \
            --zone=${{ secrets.ZONE }} \
            --command="
              cd ~/airflow_project && \
              sudo chown -R \$USER:\$USER . && \
              git pull origin main
            "

          # 2. Copy .env file to VM
          gcloud compute scp .env $SSH_USER@${{ secrets.INSTANCE_NAME }}:~/airflow_project/.env --zone=${{ secrets.ZONE }}

          gcloud compute scp airflow_settings.yaml $SSH_USER@${{ secrets.INSTANCE_NAME }}:~/airflow_project/airflow_settings.yaml --zone=${{ secrets.ZONE }}
          
          # 3. Source .env on VM (if needed for subsequent commands)
          gcloud compute ssh $SSH_USER@${{ secrets.INSTANCE_NAME }} \
            --zone=${{ secrets.ZONE }} \
            --command="
              cd ~/airflow_project && \
              set -a && source .env && set +a && \
            "

        